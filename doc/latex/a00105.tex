\hypertarget{a00105}{}\section{事件循环}
\label{a00105}\index{事件循环@{事件循环}}


网络事件循环  


\subsection*{函数}
\begin{DoxyCompactItemize}
\item 
\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$ \hyperlink{a00105_ga878bf0cd280e0bd183144bb95ca4a7b1_ga878bf0cd280e0bd183144bb95ca4a7b1}{loop\+\_\+create} ()
\begin{DoxyCompactList}\small\item\em 创建一个事件循环 \end{DoxyCompactList}\item 
void \hyperlink{a00105_ga921fd5e5e16a73de123e81baab187a0a_ga921fd5e5e16a73de123e81baab187a0a}{loop\+\_\+destroy} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop)
\begin{DoxyCompactList}\small\item\em 销毁事件循环 事件循环内的所有管道也会被销毁 \end{DoxyCompactList}\item 
\hyperlink{a00051_a151271c9d188ef28d4d24bb81dcc1263_a151271c9d188ef28d4d24bb81dcc1263}{channel\+\_\+ref\+\_\+t} $\ast$ \hyperlink{a00105_gab5b73ea9a0347b431f93ebf30ecd05b5_gab5b73ea9a0347b431f93ebf30ecd05b5}{loop\+\_\+create\+\_\+channel} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop, uint32\+\_\+t max\+\_\+send\+\_\+list\+\_\+len, uint32\+\_\+t recv\+\_\+ring\+\_\+len)
\begin{DoxyCompactList}\small\item\em 创建管道 \end{DoxyCompactList}\item 
\hyperlink{a00051_a151271c9d188ef28d4d24bb81dcc1263_a151271c9d188ef28d4d24bb81dcc1263}{channel\+\_\+ref\+\_\+t} $\ast$ \hyperlink{a00105_ga6879ac453ef83768ce8f8ef43a474409_ga6879ac453ef83768ce8f8ef43a474409}{loop\+\_\+create\+\_\+channel\+\_\+exist\+\_\+socket\+\_\+fd} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop, \hyperlink{a00051_a0d9e0afbf02fb6ed6c5b1415dce51b05_a0d9e0afbf02fb6ed6c5b1415dce51b05}{socket\+\_\+t} socket\+\_\+fd, uint32\+\_\+t max\+\_\+send\+\_\+list\+\_\+len, uint32\+\_\+t recv\+\_\+ring\+\_\+len)
\begin{DoxyCompactList}\small\item\em 使用已存在的套接字创建管道 \end{DoxyCompactList}\item 
int \hyperlink{a00105_ga2f1994d76e46cf4855ac955ccd41d9ef_ga2f1994d76e46cf4855ac955ccd41d9ef}{loop\+\_\+run\+\_\+once} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop)
\begin{DoxyCompactList}\small\item\em 运行一次事件循环 loop\+\_\+t不是线程安全的，不能在多个线程内同时对同一个loop\+\_\+t实例调用loop\+\_\+run\+\_\+once \end{DoxyCompactList}\item 
int \hyperlink{a00105_ga8eb0f6c8d398c70fc5ca2292664a1187_ga8eb0f6c8d398c70fc5ca2292664a1187}{loop\+\_\+run} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop)
\begin{DoxyCompactList}\small\item\em 运行事件循环直到调用loop\+\_\+exit() loop\+\_\+t不是线程安全的，不能在多个线程内同时对同一个loop\+\_\+t实例调用loop\+\_\+run \end{DoxyCompactList}\item 
void \hyperlink{a00105_ga898c7e8ef4ff2f360a32454b2b1013de_ga898c7e8ef4ff2f360a32454b2b1013de}{loop\+\_\+exit} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop)
\begin{DoxyCompactList}\small\item\em 退出函数loop\+\_\+run() \end{DoxyCompactList}\item 
int \hyperlink{a00105_ga6fa8f99fdc7a036fea6ca91971885e52_ga6fa8f99fdc7a036fea6ca91971885e52}{loop\+\_\+get\+\_\+active\+\_\+channel\+\_\+count} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop)
\begin{DoxyCompactList}\small\item\em 获取活跃管道数量 \end{DoxyCompactList}\item 
int \hyperlink{a00105_ga604184ddcd3e06bc7bfd4f1722778029_ga604184ddcd3e06bc7bfd4f1722778029}{loop\+\_\+get\+\_\+close\+\_\+channel\+\_\+count} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop)
\begin{DoxyCompactList}\small\item\em 获取已关闭管道数量 \end{DoxyCompactList}\item 
void \hyperlink{a00105_ga480fadf19a49cb27354866e06500a03c_ga480fadf19a49cb27354866e06500a03c}{loop\+\_\+set\+\_\+data} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop, void $\ast$data)
\begin{DoxyCompactList}\small\item\em 设置用户数据指针 \end{DoxyCompactList}\item 
\hyperlink{a00051_ad060e1396346d2f5db1ec0597376a107_ad060e1396346d2f5db1ec0597376a107}{loop\+\_\+profile\+\_\+t} $\ast$ \hyperlink{a00105_gad3f87700814d56a619ab5517b1f5fe5b_gad3f87700814d56a619ab5517b1f5fe5b}{loop\+\_\+get\+\_\+profile} (\hyperlink{a00051_a9c3ad1cd2de83e09f3a7b59fa82c94ee_a9c3ad1cd2de83e09f3a7b59fa82c94ee}{loop\+\_\+t} $\ast$loop)
\begin{DoxyCompactList}\small\item\em 取得统计器 \end{DoxyCompactList}\end{DoxyCompactItemize}


\subsection{详细描述}
网络事件循环 


\begin{DoxyPre}
网络事件API，作为各个不同操作系统网络选取器的包装，屏蔽了不同平台的具体实现，
为你提供统一的调用接口.\end{DoxyPre}



\begin{DoxyPre}管道引用channel\_ref\_t通过调用loop\_create\_channel和loop\_create\_channel\_exist\_socket\_fd
创建，loop\_run将启动事件循环并等待调用loop\_exit退出，你可以手动调用loop\_run\_once运行一次事件
循环自己控制循环的调用频率.\end{DoxyPre}



\begin{DoxyPre}每个loop\_t内都维护了活跃管道和已关闭(未销毁)管道的双向链表，可以通过loop\_get\_active\_channel\_count
和loop\_get\_close\_channel\_count来取得具体数量.\end{DoxyPre}



\begin{DoxyPre}在创建管道时，要注意两个重要的配置参数：\end{DoxyPre}



\begin{DoxyPre}1. max\_send\_list\_len 发送链表最大元素个数
2. recv\_ring\_len     接受缓冲区最大长度\end{DoxyPre}



\begin{DoxyPre}通常向管道内发送数据(stream\_push\_系列)，管道会尝试直接发送，并不缓存要发送的数据，如果因为某种原因
导致不能直接发送，数据会被缓存在发送链表内等待合适的时机发送，如果发送链表的长度达到上限，管道会被关闭.
同样，接受缓冲区会从套接字内将数据读取出来，如果你一直不从stream\_t内取数据，那么早晚会被写满，管道也
会被关闭.\end{DoxyPre}



\begin{DoxyPre}\end{DoxyPre}
 

\subsection{函数说明}
\hypertarget{a00105_ga878bf0cd280e0bd183144bb95ca4a7b1_ga878bf0cd280e0bd183144bb95ca4a7b1}{}\index{事件循环@{事件循环}!loop\+\_\+create@{loop\+\_\+create}}
\index{loop\+\_\+create@{loop\+\_\+create}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+create}]{\setlength{\rightskip}{0pt plus 5cm}{\bf loop\+\_\+t}$\ast$ loop\+\_\+create (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}\label{a00105_ga878bf0cd280e0bd183144bb95ca4a7b1_ga878bf0cd280e0bd183144bb95ca4a7b1}


创建一个事件循环 

\begin{DoxyReturn}{返回}
loop\+\_\+t实例 
\end{DoxyReturn}
\hypertarget{a00105_gab5b73ea9a0347b431f93ebf30ecd05b5_gab5b73ea9a0347b431f93ebf30ecd05b5}{}\index{事件循环@{事件循环}!loop\+\_\+create\+\_\+channel@{loop\+\_\+create\+\_\+channel}}
\index{loop\+\_\+create\+\_\+channel@{loop\+\_\+create\+\_\+channel}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+create\+\_\+channel}]{\setlength{\rightskip}{0pt plus 5cm}{\bf channel\+\_\+ref\+\_\+t}$\ast$ loop\+\_\+create\+\_\+channel (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop, }
\item[{uint32\+\_\+t}]{max\+\_\+send\+\_\+list\+\_\+len, }
\item[{uint32\+\_\+t}]{recv\+\_\+ring\+\_\+len}
\end{DoxyParamCaption}
)}\label{a00105_gab5b73ea9a0347b431f93ebf30ecd05b5_gab5b73ea9a0347b431f93ebf30ecd05b5}


创建管道 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
{\em max\+\_\+send\+\_\+list\+\_\+len} & 发送缓冲区链最大长度 \\
\hline
{\em recv\+\_\+ring\+\_\+len} & 接受环形缓冲区最大长度 \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{返回}
channel\+\_\+ref\+\_\+t实例 
\end{DoxyReturn}
\hypertarget{a00105_ga6879ac453ef83768ce8f8ef43a474409_ga6879ac453ef83768ce8f8ef43a474409}{}\index{事件循环@{事件循环}!loop\+\_\+create\+\_\+channel\+\_\+exist\+\_\+socket\+\_\+fd@{loop\+\_\+create\+\_\+channel\+\_\+exist\+\_\+socket\+\_\+fd}}
\index{loop\+\_\+create\+\_\+channel\+\_\+exist\+\_\+socket\+\_\+fd@{loop\+\_\+create\+\_\+channel\+\_\+exist\+\_\+socket\+\_\+fd}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+create\+\_\+channel\+\_\+exist\+\_\+socket\+\_\+fd}]{\setlength{\rightskip}{0pt plus 5cm}{\bf channel\+\_\+ref\+\_\+t}$\ast$ loop\+\_\+create\+\_\+channel\+\_\+exist\+\_\+socket\+\_\+fd (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop, }
\item[{{\bf socket\+\_\+t}}]{socket\+\_\+fd, }
\item[{uint32\+\_\+t}]{max\+\_\+send\+\_\+list\+\_\+len, }
\item[{uint32\+\_\+t}]{recv\+\_\+ring\+\_\+len}
\end{DoxyParamCaption}
)}\label{a00105_ga6879ac453ef83768ce8f8ef43a474409_ga6879ac453ef83768ce8f8ef43a474409}


使用已存在的套接字创建管道 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
{\em socket\+\_\+fd} & 套接字 \\
\hline
{\em max\+\_\+send\+\_\+list\+\_\+len} & 发送缓冲区链最大长度 \\
\hline
{\em recv\+\_\+ring\+\_\+len} & 接受环形缓冲区最大长度 \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{返回}
channel\+\_\+ref\+\_\+t实例 
\end{DoxyReturn}
\hypertarget{a00105_ga921fd5e5e16a73de123e81baab187a0a_ga921fd5e5e16a73de123e81baab187a0a}{}\index{事件循环@{事件循环}!loop\+\_\+destroy@{loop\+\_\+destroy}}
\index{loop\+\_\+destroy@{loop\+\_\+destroy}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+destroy}]{\setlength{\rightskip}{0pt plus 5cm}void loop\+\_\+destroy (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop}
\end{DoxyParamCaption}
)}\label{a00105_ga921fd5e5e16a73de123e81baab187a0a_ga921fd5e5e16a73de123e81baab187a0a}


销毁事件循环 事件循环内的所有管道也会被销毁 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
\end{DoxyParams}
\hypertarget{a00105_ga898c7e8ef4ff2f360a32454b2b1013de_ga898c7e8ef4ff2f360a32454b2b1013de}{}\index{事件循环@{事件循环}!loop\+\_\+exit@{loop\+\_\+exit}}
\index{loop\+\_\+exit@{loop\+\_\+exit}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+exit}]{\setlength{\rightskip}{0pt plus 5cm}void loop\+\_\+exit (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop}
\end{DoxyParamCaption}
)}\label{a00105_ga898c7e8ef4ff2f360a32454b2b1013de_ga898c7e8ef4ff2f360a32454b2b1013de}


退出函数loop\+\_\+run() 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
\end{DoxyParams}
\hypertarget{a00105_ga6fa8f99fdc7a036fea6ca91971885e52_ga6fa8f99fdc7a036fea6ca91971885e52}{}\index{事件循环@{事件循环}!loop\+\_\+get\+\_\+active\+\_\+channel\+\_\+count@{loop\+\_\+get\+\_\+active\+\_\+channel\+\_\+count}}
\index{loop\+\_\+get\+\_\+active\+\_\+channel\+\_\+count@{loop\+\_\+get\+\_\+active\+\_\+channel\+\_\+count}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+get\+\_\+active\+\_\+channel\+\_\+count}]{\setlength{\rightskip}{0pt plus 5cm}int loop\+\_\+get\+\_\+active\+\_\+channel\+\_\+count (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop}
\end{DoxyParamCaption}
)}\label{a00105_ga6fa8f99fdc7a036fea6ca91971885e52_ga6fa8f99fdc7a036fea6ca91971885e52}


获取活跃管道数量 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{返回}
活跃管道数量 
\end{DoxyReturn}
\hypertarget{a00105_ga604184ddcd3e06bc7bfd4f1722778029_ga604184ddcd3e06bc7bfd4f1722778029}{}\index{事件循环@{事件循环}!loop\+\_\+get\+\_\+close\+\_\+channel\+\_\+count@{loop\+\_\+get\+\_\+close\+\_\+channel\+\_\+count}}
\index{loop\+\_\+get\+\_\+close\+\_\+channel\+\_\+count@{loop\+\_\+get\+\_\+close\+\_\+channel\+\_\+count}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+get\+\_\+close\+\_\+channel\+\_\+count}]{\setlength{\rightskip}{0pt plus 5cm}int loop\+\_\+get\+\_\+close\+\_\+channel\+\_\+count (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop}
\end{DoxyParamCaption}
)}\label{a00105_ga604184ddcd3e06bc7bfd4f1722778029_ga604184ddcd3e06bc7bfd4f1722778029}


获取已关闭管道数量 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{返回}
关闭管道数量 
\end{DoxyReturn}
\hypertarget{a00105_gad3f87700814d56a619ab5517b1f5fe5b_gad3f87700814d56a619ab5517b1f5fe5b}{}\index{事件循环@{事件循环}!loop\+\_\+get\+\_\+profile@{loop\+\_\+get\+\_\+profile}}
\index{loop\+\_\+get\+\_\+profile@{loop\+\_\+get\+\_\+profile}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+get\+\_\+profile}]{\setlength{\rightskip}{0pt plus 5cm}{\bf loop\+\_\+profile\+\_\+t}$\ast$ loop\+\_\+get\+\_\+profile (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop}
\end{DoxyParamCaption}
)}\label{a00105_gad3f87700814d56a619ab5517b1f5fe5b_gad3f87700814d56a619ab5517b1f5fe5b}


取得统计器 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{返回}
loop\+\_\+profile\+\_\+t实例 
\end{DoxyReturn}
\hypertarget{a00105_ga8eb0f6c8d398c70fc5ca2292664a1187_ga8eb0f6c8d398c70fc5ca2292664a1187}{}\index{事件循环@{事件循环}!loop\+\_\+run@{loop\+\_\+run}}
\index{loop\+\_\+run@{loop\+\_\+run}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+run}]{\setlength{\rightskip}{0pt plus 5cm}int loop\+\_\+run (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop}
\end{DoxyParamCaption}
)}\label{a00105_ga8eb0f6c8d398c70fc5ca2292664a1187_ga8eb0f6c8d398c70fc5ca2292664a1187}


运行事件循环直到调用loop\+\_\+exit() loop\+\_\+t不是线程安全的，不能在多个线程内同时对同一个loop\+\_\+t实例调用loop\+\_\+run 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{返回值}
{\em error\+\_\+ok} & 成功 \\
\hline
{\em 其他} & 失败 \\
\hline
\end{DoxyRetVals}
\hypertarget{a00105_ga2f1994d76e46cf4855ac955ccd41d9ef_ga2f1994d76e46cf4855ac955ccd41d9ef}{}\index{事件循环@{事件循环}!loop\+\_\+run\+\_\+once@{loop\+\_\+run\+\_\+once}}
\index{loop\+\_\+run\+\_\+once@{loop\+\_\+run\+\_\+once}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+run\+\_\+once}]{\setlength{\rightskip}{0pt plus 5cm}int loop\+\_\+run\+\_\+once (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop}
\end{DoxyParamCaption}
)}\label{a00105_ga2f1994d76e46cf4855ac955ccd41d9ef_ga2f1994d76e46cf4855ac955ccd41d9ef}


运行一次事件循环 loop\+\_\+t不是线程安全的，不能在多个线程内同时对同一个loop\+\_\+t实例调用loop\+\_\+run\+\_\+once 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{返回值}
{\em error\+\_\+ok} & 成功 \\
\hline
{\em 其他} & 失败 \\
\hline
\end{DoxyRetVals}
\hypertarget{a00105_ga480fadf19a49cb27354866e06500a03c_ga480fadf19a49cb27354866e06500a03c}{}\index{事件循环@{事件循环}!loop\+\_\+set\+\_\+data@{loop\+\_\+set\+\_\+data}}
\index{loop\+\_\+set\+\_\+data@{loop\+\_\+set\+\_\+data}!事件循环@{事件循环}}
\subsubsection[{loop\+\_\+set\+\_\+data}]{\setlength{\rightskip}{0pt plus 5cm}void loop\+\_\+set\+\_\+data (
\begin{DoxyParamCaption}
\item[{{\bf loop\+\_\+t} $\ast$}]{loop, }
\item[{void $\ast$}]{data}
\end{DoxyParamCaption}
)}\label{a00105_ga480fadf19a49cb27354866e06500a03c_ga480fadf19a49cb27354866e06500a03c}


设置用户数据指针 


\begin{DoxyParams}{参数}
{\em loop} & loop\+\_\+t实例 \\
\hline
{\em data} & 用户数据指针 \\
\hline
\end{DoxyParams}
